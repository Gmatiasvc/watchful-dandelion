<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner de Asistencia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Librería para leer QR en web -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Animación para el escaneo exitoso */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .scan-success {
            animation: pulse-green 0.8s;
            border-color: #4ade80 !important;
        }
        .scan-error {
            border-color: #ef4444 !important;
        }
        
        /* Transiciones para la lista */
        .history-item {
            transition: all 0.5s ease-out;
            opacity: 0;
            transform: translateY(-20px);
        }
        .history-item.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <div class="w-full max-w-md flex justify-between items-center mb-6 text-white">
        <h1 class="text-xl font-bold"><i class="fas fa-camera mr-2"></i>Escáner QR</h1>
        <div class="flex gap-4">
            <button id="toggle-sound" class="text-gray-400 hover:text-white" title="Activar/Desactivar Sonido">
                <i class="fas fa-volume-up"></i>
            </button>
            <a href="{% url 'registro' %}" class="text-gray-400 hover:text-white text-sm">
                Registro <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
    </div>

    <!-- Contenedor del Escáner -->
    <div class="w-full max-w-md bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-800 relative transition-colors duration-300" id="reader-container">
        <div id="reader" class="w-full h-80 bg-gray-800"></div>
        
        <!-- Overlay visual de guía -->
        <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
            <div class="w-64 h-64 border-2 border-white/30 rounded-lg relative">
                <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-500 -mt-1 -ml-1"></div>
                <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-500 -mt-1 -mr-1"></div>
                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-500 -mb-1 -ml-1"></div>
                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-500 -mb-1 -mr-1"></div>
            </div>
        </div>
    </div>

    <!-- Panel de Estado / Resultados -->
    <div class="w-full max-w-md mt-6">
        <div id="status-card" class="bg-gray-800 rounded-xl p-6 text-center shadow-lg transition-all duration-300">
            <div id="status-icon" class="text-5xl mb-3 text-gray-600">
                <i class="fas fa-qrcode"></i>
            </div>
            <h2 id="status-title" class="text-xl font-bold text-white mb-1">Listo para escanear</h2>
            <p id="status-msg" class="text-gray-400 text-sm">Apunta la cámara al código QR.</p>
        </div>
    </div>

    <!-- Historial Reciente -->
    <div class="w-full max-w-md mt-8">
        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-3 ml-1">Actividad Reciente</h3>
        <div id="history-list" class="space-y-2">
            <!-- Los items se agregarán aquí dinámicamente -->
            <div id="empty-history" class="text-center py-4 text-gray-600 text-sm italic">
                Sin registros en esta sesión.
            </div>
        </div>
    </div>

    <!-- Scripts de Lógica -->
    <script>
        // Elementos DOM
        const statusCard = document.getElementById('status-card');
        const statusIcon = document.getElementById('status-icon');
        const statusTitle = document.getElementById('status-title');
        const statusMsg = document.getElementById('status-msg');
        const readerContainer = document.getElementById('reader-container');
        const historyList = document.getElementById('history-list');
        const emptyHistoryMsg = document.getElementById('empty-history');
        const toggleSoundBtn = document.getElementById('toggle-sound');

        let isProcessing = false;
        let soundEnabled = true;

        // --- SISTEMA DE AUDIO (Sintetizador Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(type) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'success') {
                // Sonido "Ding" (Seno agudo)
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'error') {
                // Sonido "Buzz" (Diente de sierra grave)
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        }

        toggleSoundBtn.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            toggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute text-red-500"></i>';
        });

        // --- LÓGICA DE ESCANEO ---

        function onScanSuccess(decodedText, decodedResult) {
            if (isProcessing) return;
            isProcessing = true;
            enviarHashAlServidor(decodedText);
        }

        function onScanFailure(error) {
            // Ignorar errores de frames vacíos
        }

        async function enviarHashAlServidor(hash) {
            actualizarUI('procesando');

            try {
                const response = await fetch('/api/procesar-qr/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hash_id: hash })
                });

                const data = await response.json();
                
                // Procesar respuesta
                if (data.status === 'success') {
                    playTone('success');
                    pulseEffect('success');
                    agregarAlHistorial(data.type, data.message);
                } else if (data.status === 'info') {
                    playTone('error'); // Usamos tono de error para info (ya registrado) para alertar
                    pulseEffect('info');
                } else {
                    playTone('error');
                    pulseEffect('error');
                }
                
                actualizarUI(data.status, data.type, data.message);

            } catch (error) {
                console.error('Error:', error);
                playTone('error');
                actualizarUI('error', null, 'Error de conexión');
            }

            // Resetear scanner después de pausa
            setTimeout(() => {
                isProcessing = false;
                actualizarUI('esperando');
            }, 2500);
        }

        function pulseEffect(type) {
            readerContainer.classList.remove('scan-success', 'scan-error');
            void readerContainer.offsetWidth; // Trigger reflow
            
            if (type === 'success') readerContainer.classList.add('scan-success');
            else readerContainer.classList.add('scan-error');
        }

        // --- GESTIÓN DE UI ---

        function actualizarUI(status, type, message) {
            statusCard.className = "bg-gray-800 rounded-xl p-6 text-center shadow-lg transition-all duration-300 transform";
            
            if (status === 'procesando') {
                statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
                statusTitle.innerText = "Procesando...";
                statusMsg.innerText = "Verificando datos...";
            } 
            else if (status === 'success') {
                const isEntrada = type === 'entrada';
                const colorClass = isEntrada ? 'green' : 'blue';
                const icon = isEntrada ? 'fa-door-open' : 'fa-door-closed';
                
                statusCard.classList.add(`bg-${colorClass}-900`, 'border', `border-${colorClass}-700`);
                statusIcon.innerHTML = `<i class="fas ${icon} text-${colorClass}-400"></i>`;
                
                // Extraer nombre del mensaje (asumiendo formato "¡Bienvenido/a, Nombre!")
                // Esto es un parche visual simple, idealmente el backend mandaría el nombre separado
                const lineas = message.split('\n');
                statusTitle.innerHTML = lineas[0];
                statusTitle.className = `text-lg font-bold text-${colorClass}-300 mb-1 leading-tight`;
                
                statusMsg.innerText = lineas[1] || "";
                statusMsg.className = "text-gray-300 text-sm font-mono";
            }
            else if (status === 'not_found') {
                statusCard.classList.add('bg-red-900', 'border', 'border-red-700');
                statusIcon.innerHTML = '<i class="fas fa-user-slash text-red-500"></i>';
                statusTitle.innerText = "No Registrado";
                statusTitle.className = "text-xl font-bold text-red-300 mb-1";
                statusMsg.innerText = "Código QR no válido.";
            }
            else if (status === 'esperando') {
                statusIcon.innerHTML = '<i class="fas fa-qrcode text-gray-600"></i>';
                statusTitle.innerText = "Listo";
                statusTitle.className = "text-xl font-bold text-white mb-1";
                statusMsg.innerText = "Apunta la cámara al QR.";
            }
            else {
                // Info / Error
                statusCard.classList.add('bg-yellow-900', 'border', 'border-yellow-700');
                statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500"></i>';
                statusTitle.innerText = "Atención";
                statusTitle.className = "text-xl font-bold text-yellow-300 mb-1";
                statusMsg.innerText = message;
            }
        }

        function agregarAlHistorial(type, message) {
            if (emptyHistoryMsg) emptyHistoryMsg.style.display = 'none';

            const item = document.createElement('div');
            const isEntrada = type === 'entrada';
            const icon = isEntrada ? 'fa-arrow-right text-green-400' : 'fa-arrow-left text-blue-400';
            const borderColor = isEntrada ? 'border-green-500/30' : 'border-blue-500/30';
            
            // Parsear mensaje para mostrarlo más limpio
            const lines = message.split('\n');
            const titulo = lines[0].replace('¡Bienvenido/a, ', '').replace('¡Hasta luego, ', '').replace('!', '');
            const hora = lines[1] ? lines[1].split(': ')[1] : new Date().toLocaleTimeString();

            item.className = `history-item bg-gray-800 border-l-4 ${borderColor} p-3 rounded shadow flex items-center justify-between text-white`;
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="bg-gray-700 w-8 h-8 rounded-full flex items-center justify-center">
                        <i class="fas ${icon} text-sm"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm text-gray-200">${titulo}</p>
                        <p class="text-xs text-gray-500 capitalize">${type}</p>
                    </div>
                </div>
                <div class="text-xs font-mono text-gray-400">
                    ${hora}
                </div>
            `;

            historyList.prepend(item);

            // Trigger animación
            setTimeout(() => item.classList.add('show'), 10);

            // Mantener solo 5 items
            if (historyList.children.length > 5) {
                historyList.lastElementChild.remove();
            }
        }

        // --- INICIALIZACIÓN ---
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            false
        );
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);

        // Fix de estilo al cargar
        document.getElementById('reader').style.background = "transparent";
    </script>
</body>
</html>