<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner de Asistencia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Librería para leer QR en web -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Animación para el escaneo exitoso */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .scan-success {
            animation: pulse-green 1s;
            border-color: #4ade80 !important;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <div class="w-full max-w-md flex justify-between items-center mb-6 text-white">
        <h1 class="text-xl font-bold"><i class="fas fa-camera mr-2"></i>Escáner QR</h1>
        <a href="{% url 'registro' %}" class="text-gray-400 hover:text-white text-sm">
            Ir a Registro <i class="fas fa-arrow-right ml-1"></i>
        </a>
    </div>

    <!-- Contenedor del Escáner -->
    <div class="w-full max-w-md bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-800 relative" id="reader-container">
        <div id="reader" class="w-full h-80 bg-gray-800"></div>
        
        <!-- Overlay visual de guía -->
        <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
            <div class="w-64 h-64 border-2 border-white/30 rounded-lg relative">
                <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-500 -mt-1 -ml-1"></div>
                <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-500 -mt-1 -mr-1"></div>
                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-500 -mb-1 -ml-1"></div>
                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-500 -mb-1 -mr-1"></div>
            </div>
        </div>
    </div>

    <!-- Panel de Estado / Resultados -->
    <div class="w-full max-w-md mt-6">
        <div id="status-card" class="bg-gray-800 rounded-xl p-6 text-center shadow-lg transition-all duration-300">
            <div id="status-icon" class="text-5xl mb-3 text-gray-600">
                <i class="fas fa-qrcode"></i>
            </div>
            <h2 id="status-title" class="text-xl font-bold text-white mb-1">Esperando Escaneo...</h2>
            <p id="status-msg" class="text-gray-400 text-sm">Apunta la cámara al código QR del usuario.</p>
        </div>
    </div>

    <!-- Scripts de Lógica -->
    <script>
        const statusCard = document.getElementById('status-card');
        const statusIcon = document.getElementById('status-icon');
        const statusTitle = document.getElementById('status-title');
        const statusMsg = document.getElementById('status-msg');
        const readerContainer = document.getElementById('reader-container');

        let isProcessing = false; // Evitar lecturas múltiples muy rápidas

        function onScanSuccess(decodedText, decodedResult) {
            if (isProcessing) return;
            
            // Verificamos si es un hash válido (longitud 64 típica de sha256)
            // Opcional: podrías validar la longitud aquí
            
            isProcessing = true;
            enviarHashAlServidor(decodedText);
            
            // Pausa visual breve
            readerContainer.classList.add('scan-success');
            setTimeout(() => {
                readerContainer.classList.remove('scan-success');
            }, 1000);
        }

        function onScanFailure(error) {
            // No hacer nada, es muy ruidoso loguear cada frame fallido
        }

        async function enviarHashAlServidor(hash) {
            actualizarUI('procesando');

            try {
                const response = await fetch('/api/procesar-qr/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ hash_id: hash })
                });

                const data = await response.json();
                actualizarUI(data.status, data.type, data.message);

            } catch (error) {
                console.error('Error:', error);
                actualizarUI('error', null, 'Error de conexión con el servidor');
            }

            // Permitir escanear de nuevo después de 3 segundos
            setTimeout(() => {
                isProcessing = false;
                actualizarUI('esperando');
            }, 3000);
        }

        function actualizarUI(status, type, message) {
            statusCard.className = "bg-gray-800 rounded-xl p-6 text-center shadow-lg transition-all duration-300 transform";
            
            if (status === 'procesando') {
                statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
                statusTitle.innerText = "Procesando...";
                statusMsg.innerText = "Verificando en base de datos";
            } 
            else if (status === 'success') {
                if (type === 'entrada') {
                    statusCard.classList.add('bg-green-900', 'border', 'border-green-700');
                    statusIcon.innerHTML = '<i class="fas fa-door-open text-green-400"></i>';
                    statusTitle.innerText = "¡Bienvenido!";
                    statusTitle.className = "text-xl font-bold text-green-300 mb-1";
                } else {
                    statusCard.classList.add('bg-blue-900', 'border', 'border-blue-700');
                    statusIcon.innerHTML = '<i class="fas fa-door-closed text-blue-400"></i>';
                    statusTitle.innerText = "¡Hasta luego!";
                    statusTitle.className = "text-xl font-bold text-blue-300 mb-1";
                }
                statusMsg.innerText = message;
                statusMsg.className = "text-gray-300 text-sm";
            }
            else if (status === 'info') {
                statusCard.classList.add('bg-yellow-900', 'border', 'border-yellow-700');
                statusIcon.innerHTML = '<i class="fas fa-exclamation-circle text-yellow-500"></i>';
                statusTitle.innerText = "Información";
                statusTitle.className = "text-xl font-bold text-yellow-300 mb-1";
                statusMsg.innerText = message;
                statusMsg.className = "text-gray-300 text-sm";
            }
            else if (status === 'not_found') {
                statusCard.classList.add('bg-red-900', 'border', 'border-red-700');
                statusIcon.innerHTML = '<i class="fas fa-user-slash text-red-500"></i>';
                statusTitle.innerText = "No Encontrado";
                statusTitle.className = "text-xl font-bold text-red-300 mb-1";
                statusMsg.innerText = "Este código QR no está registrado.";
                statusMsg.className = "text-gray-300 text-sm";
            }
            else if (status === 'esperando') {
                statusIcon.innerHTML = '<i class="fas fa-qrcode text-gray-600"></i>';
                statusTitle.innerText = "Esperando Escaneo...";
                statusTitle.className = "text-xl font-bold text-white mb-1";
                statusMsg.innerText = "Apunta la cámara al código QR.";
                statusMsg.className = "text-gray-400 text-sm";
            }
            else { // Error genérico
                statusCard.classList.add('bg-red-900');
                statusIcon.innerHTML = '<i class="fas fa-bug text-red-500"></i>';
                statusTitle.innerText = "Error";
                statusMsg.innerText = message || "Ocurrió un error inesperado";
            }
        }

        // Configuración e inicio del escáner
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            /* verbose= */ false
        );
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);

        // Limpiar vista al inicio
        document.getElementById('reader').style.background = "transparent";
    </script>
</body>
</html>